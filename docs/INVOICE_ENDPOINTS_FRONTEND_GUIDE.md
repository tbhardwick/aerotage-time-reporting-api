# Invoice Management API - Frontend Integration Guide

## üìã Overview

This guide provides complete instructions for integrating with the Aerotage Time Reporting API's invoice management endpoints. All endpoints are live and operational in the development environment with full business functionality.

## üåê Environment Details

- **API Base URL**: `https://k60bobrd9h.execute-api.us-east-1.amazonaws.com/dev`
- **Authentication**: AWS Cognito JWT tokens
- **Environment**: Development (production-ready)

## üîê Authentication Setup

### Cognito Configuration
```javascript
const cognitoConfig = {
  userPoolId: 'us-east-1_EsdlgX9Qg',
  clientId: '148r35u6uultp1rmfdu22i8amb',
  region: 'us-east-1'
};
```

### Authentication Flow
1. **Login with Cognito** to get JWT token
2. **Use the correct token property**: `authResult.token` (NOT `authResult.AccessToken`)
3. **Include in headers**: `Authorization: Bearer ${token}`

### ‚ö†Ô∏è Critical Authentication Note
**ALWAYS use `authResult.token`** - Using `authResult.AccessToken` will result in 403 Forbidden errors.

```javascript
// ‚úÖ CORRECT
const authResult = await getCognitoToken(email, password);
const token = authResult.token;

// ‚ùå INCORRECT (causes 403 errors)
const token = authResult.AccessToken; // This is undefined!
```

## üìä Available Invoice Endpoints

### 1. List Invoices - `GET /invoices`

**Purpose**: Retrieve a paginated list of invoices with filtering and sorting options.

**Request Parameters** (Query String):
```javascript
{
  clientId?: string,           // Filter by specific client
  projectId?: string,          // Filter by specific project
  status?: string,             // 'draft' | 'sent' | 'viewed' | 'paid' | 'overdue' | 'cancelled' | 'refunded'
  isRecurring?: boolean,       // Filter recurring invoices
  dateFrom?: string,           // ISO date (YYYY-MM-DD)
  dateTo?: string,             // ISO date (YYYY-MM-DD)
  dueDateFrom?: string,        // ISO date (YYYY-MM-DD)
  dueDateTo?: string,          // ISO date (YYYY-MM-DD)
  amountMin?: number,          // Minimum amount filter
  amountMax?: number,          // Maximum amount filter
  currency?: string,           // Currency code (e.g., 'USD')
  limit?: number,              // Items per page (default: 50, max: 100)
  offset?: number,             // Pagination offset (default: 0)
  sortBy?: string,             // 'invoiceNumber' | 'issueDate' | 'dueDate' | 'totalAmount' | 'status'
  sortOrder?: string           // 'asc' | 'desc'
}
```

**Example Request**:
```javascript
const response = await fetch(`${API_BASE_URL}/invoices?status=paid&limit=20&sortBy=issueDate&sortOrder=desc`, {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});
```

**Response Format**:
```javascript
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "invoice_1748354203364_jaeja71bi",
        "invoiceNumber": "INV-2025-05-032",
        "clientId": "test-client-123",
        "clientName": "Client test-client-123",
        "projectIds": [],
        "timeEntryIds": [],
        "status": "paid",
        "issueDate": "2025-05-27",
        "dueDate": "2025-06-26",
        "paidDate": "2025-05-27",
        "subtotal": 150,
        "taxRate": 0.08,
        "taxAmount": 0.12,
        "discountAmount": 0,
        "totalAmount": 150.12,
        "currency": "USD",
        "lineItems": [
          {
            "type": "fixed",
            "description": "Quick Test Service",
            "quantity": 1,
            "rate": 150,
            "amount": 150,
            "taxable": true,
            "id": "line_1748354203927_kjm411xwe"
          }
        ],
        "paymentTerms": "Net 30",
        "isRecurring": false,
        "remindersSent": 0,
        "notes": "Generated by quick test script",
        "createdAt": "2025-05-27T13:56:43.364Z",
        "updatedAt": "2025-05-27T13:56:47.186Z",
        "createdBy": "0408a498-40c1-7071-acc9-90665ef117c3"
      }
    ],
    "pagination": {
      "total": 32,
      "limit": 50,
      "offset": 0,
      "hasMore": false
    }
  }
}
```

### 2. Create Invoice - `POST /invoices`

**Purpose**: Generate a new invoice from time entries, projects, or custom line items.

**Request Body**:
```javascript
{
  "clientId": "client-uuid",                    // Required
  "projectIds": ["project-uuid-1"],            // Optional
  "timeEntryIds": ["entry-uuid-1"],            // Optional
  "templateId": "template-uuid",               // Optional
  "issueDate": "2025-05-27",                   // Optional (defaults to today)
  "dueDate": "2025-06-26",                     // Optional (calculated from payment terms)
  "paymentTerms": "Net 30",                    // Optional (defaults to client's default)
  "currency": "USD",                           // Optional (defaults to client's default)
  "taxRate": 0.08,                             // Optional (8% = 0.08)
  "discountRate": 0.05,                        // Optional (5% = 0.05)
  "additionalLineItems": [                     // Optional
    {
      "type": "fixed",                         // 'time' | 'expense' | 'fixed' | 'discount'
      "description": "Setup Fee",
      "quantity": 1,
      "rate": 100.00,
      "amount": 100.00,
      "taxable": true
    }
  ],
  "notes": "Internal notes",                   // Optional
  "clientNotes": "Notes visible to client",    // Optional
  "isRecurring": false,                        // Optional
  "recurringConfig": {                         // Required if isRecurring = true
    "frequency": "monthly",                    // 'weekly' | 'monthly' | 'quarterly' | 'yearly'
    "interval": 1,                             // Every X periods
    "startDate": "2025-05-27",                 // When to start recurring
    "endDate": "2025-12-31",                   // Optional end date
    "maxInvoices": 12,                         // Optional max count
    "autoSend": false,                         // Auto-send generated invoices
    "generateDaysBefore": 3                    // Days before due date to generate
  }
}
```

**Example Request**:
```javascript
const invoiceData = {
  clientId: 'client-123',
  additionalLineItems: [
    {
      type: 'fixed',
      description: 'Consulting Services',
      quantity: 10,
      rate: 150.00,
      amount: 1500.00,
      taxable: true
    }
  ],
  paymentTerms: 'Net 30',
  currency: 'USD',
  taxRate: 0.08,
  notes: 'Monthly consulting invoice'
};

const response = await fetch(`${API_BASE_URL}/invoices`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(invoiceData)
});
```

**Response Format**:
```javascript
{
  "success": true,
  "data": {
    "id": "invoice_1748354203364_jaeja71bi",
    "invoiceNumber": "INV-2025-05-033",
    "status": "draft",
    "totalAmount": 1620.00,
    // ... full invoice object
  }
}
```

### 3. Update Invoice - `PUT /invoices/{id}`

**Purpose**: Update invoice details (only for draft invoices).

**Request Body** (all fields optional):
```javascript
{
  "dueDate": "2025-07-15",
  "paymentTerms": "Net 45",
  "taxRate": 0.10,
  "discountRate": 0.05,
  "lineItems": [
    {
      "id": "line_123",                        // Required for existing items
      "type": "fixed",
      "description": "Updated Service",
      "quantity": 2,
      "rate": 200.00,
      "amount": 400.00,
      "taxable": true
    }
  ],
  "notes": "Updated internal notes",
  "clientNotes": "Updated client notes",
  "customFields": {
    "purchaseOrder": "PO-12345"
  }
}
```

**Example Request**:
```javascript
const updateData = {
  paymentTerms: 'Net 45',
  notes: 'Updated payment terms to 45 days'
};

const response = await fetch(`${API_BASE_URL}/invoices/${invoiceId}`, {
  method: 'PUT',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(updateData)
});
```

### 4. Send Invoice - `POST /invoices/{id}/send`

**Purpose**: Send invoice via email to client.

**Request Body**:
```javascript
{
  "recipientEmails": ["client@example.com"],   // Optional (defaults to client email)
  "subject": "Invoice INV-2025-05-033",       // Optional (auto-generated)
  "message": "Please find your invoice attached.", // Optional
  "attachPdf": true,                           // Whether to attach PDF
  "sendCopy": true,                            // Send copy to sender
  "scheduleDate": "2025-05-28T09:00:00Z"      // Optional (send immediately if not provided)
}
```

**Example Request**:
```javascript
const sendData = {
  recipientEmails: ['client@example.com', 'accounting@client.com'],
  subject: 'Monthly Invoice - May 2025',
  message: 'Thank you for your business. Please find your invoice attached.',
  attachPdf: true,
  sendCopy: true
};

const response = await fetch(`${API_BASE_URL}/invoices/${invoiceId}/send`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(sendData)
});
```

### 5. Update Invoice Status - `PUT /invoices/{id}/status`

**Purpose**: Update invoice status and record payments.

**Request Body**:
```javascript
{
  "status": "paid",                            // Required: new status
  "paymentData": {                             // Required if status = 'paid'
    "amount": 1620.00,                         // Payment amount
    "paymentDate": "2025-05-27",               // Payment date
    "paymentMethod": "Bank Transfer",          // Payment method
    "reference": "TXN-12345",                  // Payment reference
    "notes": "Payment received via wire transfer",
    "externalPaymentId": "stripe_12345",       // Optional external ID
    "processorFee": 25.00                      // Optional processor fee
  }
}
```

**Example Request**:
```javascript
const statusData = {
  status: 'paid',
  paymentData: {
    amount: 1620.00,
    paymentDate: '2025-05-27',
    paymentMethod: 'Credit Card',
    reference: 'CC-789456',
    notes: 'Payment processed successfully'
  }
};

const response = await fetch(`${API_BASE_URL}/invoices/${invoiceId}/status`, {
  method: 'PUT',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(statusData)
});
```

## üé® React Integration Examples

### Invoice List Component

```jsx
import React, { useState, useEffect } from 'react';

const InvoiceList = ({ token }) => {
  const [invoices, setInvoices] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filters, setFilters] = useState({
    status: '',
    limit: 20,
    offset: 0
  });

  const fetchInvoices = async () => {
    setLoading(true);
    try {
      const queryParams = new URLSearchParams();
      Object.entries(filters).forEach(([key, value]) => {
        if (value) queryParams.append(key, value);
      });

      const response = await fetch(
        `${API_BASE_URL}/invoices?${queryParams}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      const data = await response.json();
      if (data.success) {
        setInvoices(data.data.items);
      }
    } catch (error) {
      console.error('Failed to fetch invoices:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchInvoices();
  }, [filters]);

  const handleStatusFilter = (status) => {
    setFilters(prev => ({ ...prev, status, offset: 0 }));
  };

  if (loading) return <div>Loading invoices...</div>;

  return (
    <div className="invoice-list">
      <div className="filters">
        <button onClick={() => handleStatusFilter('')}>All</button>
        <button onClick={() => handleStatusFilter('draft')}>Draft</button>
        <button onClick={() => handleStatusFilter('sent')}>Sent</button>
        <button onClick={() => handleStatusFilter('paid')}>Paid</button>
        <button onClick={() => handleStatusFilter('overdue')}>Overdue</button>
      </div>

      <div className="invoice-grid">
        {invoices.map(invoice => (
          <div key={invoice.id} className="invoice-card">
            <h3>{invoice.invoiceNumber}</h3>
            <p>Client: {invoice.clientName}</p>
            <p>Amount: {invoice.currency} {invoice.totalAmount}</p>
            <p>Status: <span className={`status-${invoice.status}`}>
              {invoice.status.toUpperCase()}
            </span></p>
            <p>Due: {invoice.dueDate}</p>
          </div>
        ))}
      </div>
    </div>
  );
};
```

### Create Invoice Component

```jsx
import React, { useState } from 'react';

const CreateInvoice = ({ token, onInvoiceCreated }) => {
  const [formData, setFormData] = useState({
    clientId: '',
    paymentTerms: 'Net 30',
    currency: 'USD',
    taxRate: 0.08,
    lineItems: [
      {
        type: 'fixed',
        description: '',
        quantity: 1,
        rate: 0,
        taxable: true
      }
    ]
  });
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    try {
      // Calculate amounts for line items
      const processedLineItems = formData.lineItems.map(item => ({
        ...item,
        amount: item.quantity * item.rate
      }));

      const invoiceData = {
        ...formData,
        additionalLineItems: processedLineItems
      };

      const response = await fetch(`${API_BASE_URL}/invoices`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(invoiceData)
      });

      const data = await response.json();
      if (data.success) {
        onInvoiceCreated(data.data);
        // Reset form or redirect
      } else {
        console.error('Failed to create invoice:', data.error);
      }
    } catch (error) {
      console.error('Error creating invoice:', error);
    } finally {
      setLoading(false);
    }
  };

  const addLineItem = () => {
    setFormData(prev => ({
      ...prev,
      lineItems: [
        ...prev.lineItems,
        {
          type: 'fixed',
          description: '',
          quantity: 1,
          rate: 0,
          taxable: true
        }
      ]
    }));
  };

  return (
    <form onSubmit={handleSubmit} className="create-invoice-form">
      <div className="form-group">
        <label>Client ID:</label>
        <input
          type="text"
          value={formData.clientId}
          onChange={(e) => setFormData(prev => ({
            ...prev,
            clientId: e.target.value
          }))}
          required
        />
      </div>

      <div className="form-group">
        <label>Payment Terms:</label>
        <select
          value={formData.paymentTerms}
          onChange={(e) => setFormData(prev => ({
            ...prev,
            paymentTerms: e.target.value
          }))}
        >
          <option value="Net 15">Net 15</option>
          <option value="Net 30">Net 30</option>
          <option value="Net 45">Net 45</option>
          <option value="Due on receipt">Due on receipt</option>
        </select>
      </div>

      <div className="line-items">
        <h3>Line Items</h3>
        {formData.lineItems.map((item, index) => (
          <div key={index} className="line-item">
            <input
              type="text"
              placeholder="Description"
              value={item.description}
              onChange={(e) => {
                const newItems = [...formData.lineItems];
                newItems[index].description = e.target.value;
                setFormData(prev => ({ ...prev, lineItems: newItems }));
              }}
              required
            />
            <input
              type="number"
              placeholder="Quantity"
              value={item.quantity}
              onChange={(e) => {
                const newItems = [...formData.lineItems];
                newItems[index].quantity = parseFloat(e.target.value);
                setFormData(prev => ({ ...prev, lineItems: newItems }));
              }}
              required
            />
            <input
              type="number"
              step="0.01"
              placeholder="Rate"
              value={item.rate}
              onChange={(e) => {
                const newItems = [...formData.lineItems];
                newItems[index].rate = parseFloat(e.target.value);
                setFormData(prev => ({ ...prev, lineItems: newItems }));
              }}
              required
            />
            <span>Amount: ${(item.quantity * item.rate).toFixed(2)}</span>
          </div>
        ))}
        <button type="button" onClick={addLineItem}>Add Line Item</button>
      </div>

      <button type="submit" disabled={loading}>
        {loading ? 'Creating...' : 'Create Invoice'}
      </button>
    </form>
  );
};
```

## üö® Error Handling

### Common Error Responses

```javascript
// Validation Error
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Line item 1: type must be one of: time, expense, fixed, discount"
  },
  "timestamp": "2025-05-27T20:35:27.443Z"
}

// Authentication Error
{
  "message": "User is not authorized to access this resource with an explicit deny"
}

// Not Found Error
{
  "success": false,
  "error": {
    "code": "INVOICE_NOT_FOUND",
    "message": "Invoice not found"
  }
}
```

### Error Handling Best Practices

```javascript
const handleApiCall = async (apiCall) => {
  try {
    const response = await apiCall();
    const data = await response.json();
    
    if (!response.ok) {
      if (response.status === 403) {
        // Authentication issue - redirect to login
        throw new Error('Authentication required');
      } else if (response.status === 404) {
        throw new Error('Invoice not found');
      } else if (response.status === 400) {
        // Validation error - show specific message
        throw new Error(data.error?.message || 'Validation failed');
      }
      throw new Error('API request failed');
    }
    
    if (!data.success) {
      throw new Error(data.error?.message || 'Request failed');
    }
    
    return data.data;
  } catch (error) {
    console.error('API Error:', error);
    throw error;
  }
};
```

## üìù Invoice Status Workflow

```
draft ‚Üí sent ‚Üí viewed ‚Üí paid
  ‚Üì       ‚Üì       ‚Üì       ‚Üì
cancelled  cancelled  overdue  refunded
```

### Status Descriptions
- **draft**: Invoice created but not sent
- **sent**: Invoice emailed to client
- **viewed**: Client has opened the invoice
- **paid**: Payment received and recorded
- **overdue**: Past due date without payment
- **cancelled**: Invoice cancelled before payment
- **refunded**: Payment refunded after being paid

## üîÑ Recurring Invoices

### Setting Up Recurring Invoices

```javascript
const recurringInvoiceData = {
  clientId: 'client-123',
  isRecurring: true,
  recurringConfig: {
    frequency: 'monthly',        // weekly, monthly, quarterly, yearly
    interval: 1,                 // Every 1 month
    startDate: '2025-06-01',     // First invoice date
    endDate: '2025-12-31',       // Optional end date
    maxInvoices: 12,             // Optional max count
    autoSend: false,             // Don't auto-send (review first)
    generateDaysBefore: 3        // Generate 3 days before due
  },
  // ... other invoice data
};
```

## üí° Best Practices

### 1. Authentication
- Always use `authResult.token`, never `authResult.AccessToken`
- Handle 403 errors by redirecting to login
- Refresh tokens before they expire

### 2. Data Validation
- Validate line items before sending
- Ensure required fields are present
- Handle validation errors gracefully

### 3. User Experience
- Show loading states during API calls
- Provide clear error messages
- Implement optimistic updates where appropriate

### 4. Performance
- Implement pagination for invoice lists
- Cache invoice data when appropriate
- Use debounced search/filtering

## üß™ Testing

### Test Credentials
```javascript
const testCredentials = {
  email: 'bhardwick@aerotage.com',
  password: 'Aerotage*2025'
};
```

### Sample Test Data
```javascript
const testInvoiceData = {
  clientId: 'test-client-123',
  additionalLineItems: [
    {
      type: 'fixed',
      description: 'Test Service',
      quantity: 1,
      rate: 100.00,
      amount: 100.00,
      taxable: true
    }
  ],
  paymentTerms: 'Net 30',
  currency: 'USD',
  notes: 'Test invoice creation'
};
```

## üìû Support

For technical issues or questions about the invoice endpoints:

1. **Check CloudWatch Logs**: All endpoints have comprehensive logging
2. **Verify Authentication**: Ensure you're using the correct token property
3. **Validate Request Data**: Check that all required fields are present and properly formatted
4. **Review Error Messages**: API provides detailed validation error messages

The invoice management system is fully operational and production-ready with complete business logic, validation, and error handling. 