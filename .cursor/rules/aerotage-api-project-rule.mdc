---
description: 
globs: 
alwaysApply: true
---
# Aerotage Time Reporting API - Backend Repository - Cursor Rules

## ğŸ—ï¸ Repository Architecture Overview

This project uses a **two-repository architecture** to separate concerns:

### ğŸš€ **aerotage-time-reporting-api** (THIS REPOSITORY)
**Purpose**: Backend AWS serverless infrastructure and API
**Current Status**: âœ… **Phase 1-3 Complete, Infrastructure Deployed**
**Contains**:
- AWS CDK infrastructure code (TypeScript) - âœ… **DEPLOYED**
- AWS Lambda function implementations - âœ… **30+ FUNCTIONS OPERATIONAL**
- DynamoDB table definitions and schema - âœ… **8 TABLES WITH GSIs**
- API Gateway REST API configurations - âœ… **15+ ENDPOINTS LIVE**
- AWS Cognito authentication infrastructure - âœ… **FULLY CONFIGURED**
- CloudWatch monitoring and logging setup - âœ… **ACTIVE MONITORING**
- S3 storage bucket configurations - âœ… **DEPLOYED**
- IAM roles and security policies - âœ… **LEAST PRIVILEGE**
- Comprehensive documentation - âœ… **COMPLETE**

### ğŸ“± **aerotage_time_reporting_app** (SEPARATE REPOSITORY)
**Purpose**: Frontend Electron desktop application
**Current Status**: ğŸ”„ **Integration Phase**
**Contains**: 
- Electron main process, renderer, and preload scripts
- React/TypeScript frontend code
- UI components, pages, and styling
- State management (React Context)
- Frontend configuration and build tools
- Documentation specific to frontend development

### ğŸ”„ **Repository Interaction Rules**
1. **Backend NEVER contains**: Electron code, React components, frontend styling, UI logic
2. **Frontend NEVER contains**: AWS CDK code, Lambda functions, infrastructure definitions
3. **API Endpoints**: âœ… **15+ endpoints implemented and documented**
4. **Authentication**: âœ… **Cognito fully configured, frontend integration ready**
5. **Deployment**: âœ… **Backend infrastructure deployed and operational**

## ğŸ“Š Current Project Status

### âœ… **Completed Features (Production Ready)**
- **User Management**: Profile CRUD, preferences, role-based access
- **Authentication & Security**: JWT tokens, password reset, MFA support
- **Session Management**: Multi-session tracking, device management
- **User Invitations**: Email-based invitation system with role assignment
- **Email Service**: SES integration with professional templates
- **Infrastructure**: Complete AWS CDK deployment with monitoring

### ğŸ”„ **Current Focus**
- **Frontend Integration**: API client implementation and testing
- **Performance Optimization**: Load testing and optimization
- **Production Deployment**: Staging and production environment setup

### ğŸ“‹ **Next Development Phases**
- **Phase 4**: Time Entry Management (CRUD, timers, approval workflow)
- **Phase 5**: Project & Client Management (projects, teams, budgets)
- **Phase 6**: Reporting & Analytics (time reports, business intelligence)
- **Phase 7**: Invoice Generation (automated billing, PDF generation)

## ğŸŒ Current Infrastructure

### **Live Environment Details**
- **API Base URL**: `https://0z6kxagbh2.execute-api.us-east-1.amazonaws.com/dev/`
- **API Documentation**: `https://d2xyhdliouir95.cloudfront.net` (Interactive Swagger UI)
- **Cognito User Pool**: `us-east-1_EsdlgX9Qg`
- **App Client**: `148r35u6uultp1rmfdu22i8amb`
- **Identity Pool**: `us-east-1:d79776bb-4b8e-4654-a10a-a45b1adaa787`
- **Environment**: Development (staging/production ready for deployment)

### **Deployed AWS Resources**
- âœ… **6 CDK Stacks**: Auth, Database, API, Storage, Documentation, Monitoring
- âœ… **8 DynamoDB Tables**: Users, profiles, preferences, sessions, invitations, etc.
- âœ… **30+ Lambda Functions**: All user management and security endpoints
- âœ… **S3 Buckets**: File storage with lifecycle policies + documentation hosting
- âœ… **CloudFront**: CDN for OpenAPI documentation hosting
- âœ… **CloudWatch**: Comprehensive monitoring and alerting
- âœ… **SES**: Email service with professional templates
- âœ… **OpenAPI Documentation**: Interactive Swagger UI with live API testing

## Core Technology Stack

### Infrastructure & Deployment
- **Infrastructure as Code**: AWS CDK v2 with TypeScript âœ… **DEPLOYED**
- **Compute**: AWS Lambda functions (Node.js 20.x) âœ… **30+ FUNCTIONS**
- **API**: Amazon API Gateway (REST API) âœ… **OPERATIONAL**
- **Database**: Amazon DynamoDB (optimized table design) âœ… **8 TABLES**
- **Authentication**: Amazon Cognito (User Pools + Identity Pools) âœ… **CONFIGURED**
- **Storage**: Amazon S3 (file uploads, exports) âœ… **DEPLOYED**
- **Email**: Amazon SES (templates, delivery tracking) âœ… **ACTIVE**
- **Monitoring**: Amazon CloudWatch (logs, metrics, alarms) âœ… **MONITORING**
- **Security**: AWS IAM (least privilege access) âœ… **IMPLEMENTED**

### Development Tools
- **Language**: TypeScript (strict mode)
- **Package Manager**: npm
- **Linting**: ESLint with AWS CDK recommended rules
- **Testing**: Jest for unit tests, AWS CDK testing constructs
- **Deployment**: AWS CDK CLI with multiple environments

## ğŸ“¡ Implemented API Endpoints

### âœ… **Live Endpoints (Production Ready)**

#### **User Management**
- `GET /users` - List all users (admin/manager)
- `GET /users/{id}/profile` - Get user profile
- `PUT /users/{id}/profile` - Update user profile
- `GET /users/{id}/preferences` - Get user preferences
- `PUT /users/{id}/preferences` - Update user preferences

#### **Security & Authentication**
- `PUT /users/{id}/password` - Change password
- `GET /users/{id}/security-settings` - Get security settings
- `PUT /users/{id}/security-settings` - Update security settings

#### **Session Management**
- `GET /users/{id}/sessions` - List user sessions
- `POST /users/{id}/sessions` - Create session record
- `DELETE /users/{id}/sessions/{sessionId}` - Terminate session

#### **User Invitations**
- `GET /user-invitations` - List invitations
- `POST /user-invitations` - Create invitation
- `POST /user-invitations/{id}/resend` - Resend invitation
- `DELETE /user-invitations/{id}` - Cancel invitation
- `GET /user-invitations/validate/{token}` - Validate token (public)
- `POST /user-invitations/accept` - Accept invitation (public)

### ğŸ“‹ **Planned Endpoints (Future Phases)**
- `/time-entries/*` - Time tracking (Phase 4)
- `/projects/*` - Project management (Phase 5)
- `/teams/*` - Team management (Phase 5)
- `/clients/*` - Client management (Phase 5)
- `/reports/*` - Reporting & analytics (Phase 6)
- `/invoices/*` - Invoice generation (Phase 7)

## File Structure Rules

```
infrastructure/
â”œâ”€â”€ bin/
â”‚   â””â”€â”€ aerotage-time-api.ts          # âœ… CDK app entry point
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ cognito-stack.ts              # âœ… Authentication infrastructure
â”‚   â”œâ”€â”€ database-stack.ts             # âœ… DynamoDB tables and indexes
â”‚   â”œâ”€â”€ api-stack.ts                  # âœ… API Gateway and Lambda integrations
â”‚   â”œâ”€â”€ storage-stack.ts              # âœ… S3 buckets and policies
â”‚   â”œâ”€â”€ ses-stack.ts                  # âœ… Email service configuration
â”‚   â”œâ”€â”€ documentation-stack.ts        # âœ… OpenAPI/Swagger UI hosting
â”‚   â””â”€â”€ monitoring-stack.ts           # âœ… CloudWatch logs, metrics, alarms
â”œâ”€â”€ lambda/
â”‚   â”œâ”€â”€ users/                        # âœ… User management functions (6 endpoints)
â”‚   â”œâ”€â”€ security/                     # âœ… Security and auth functions (3 endpoints)
â”‚   â”œâ”€â”€ sessions/                     # âœ… Session management functions (3 endpoints)
â”‚   â”œâ”€â”€ invitations/                  # âœ… User invitation functions (6 endpoints)
â”‚   â”œâ”€â”€ time-entries/                 # ğŸ“‹ Time tracking (Phase 4)
â”‚   â”œâ”€â”€ projects/                     # ğŸ“‹ Project management (Phase 5)
â”‚   â”œâ”€â”€ clients/                      # ğŸ“‹ Client management (Phase 5)
â”‚   â”œâ”€â”€ teams/                        # ğŸ“‹ Team management (Phase 5)
â”‚   â”œâ”€â”€ reports/                      # ğŸ“‹ Reporting (Phase 6)
â”‚   â””â”€â”€ invoices/                     # ğŸ“‹ Invoice generation (Phase 7)
â”œâ”€â”€ test/                             # âœ… CDK and Lambda unit tests
â”œâ”€â”€ scripts/                          # âœ… Build and utility scripts
â”‚   â””â”€â”€ build-openapi.js              # âœ… OpenAPI specification builder
â”œâ”€â”€ docs/                             # âœ… Comprehensive API documentation
â”‚   â”œâ”€â”€ README.md                     # Documentation navigation
â”‚   â”œâ”€â”€ API_REFERENCE.md              # Complete API documentation
â”‚   â”œâ”€â”€ openapi.yaml                  # âœ… OpenAPI 3.0 specification
â”‚   â”œâ”€â”€ OPENAPI_DOCUMENTATION.md      # âœ… OpenAPI system documentation
â”‚   â”œâ”€â”€ swagger-ui/                   # âœ… Swagger UI hosting files
â”‚   â”œâ”€â”€ PROJECT_STATUS.md             # Current implementation status
â”‚   â”œâ”€â”€ SECURITY_GUIDE.md             # Security implementation
â”‚   â”œâ”€â”€ DEPLOYMENT_GUIDE.md           # Infrastructure deployment
â”‚   â”œâ”€â”€ FRONTEND_INTEGRATION_GUIDE.md # Frontend integration
â”‚   â”œâ”€â”€ DEVELOPMENT.md                # Development setup
â”‚   â”œâ”€â”€ LINTING_GUIDE.md              # Code quality standards
â”‚   â””â”€â”€ TROUBLESHOOTING.md            # Issue resolution
â”œâ”€â”€ cdk.json                          # âœ… CDK configuration
â”œâ”€â”€ package.json                      # âœ… Dependencies and scripts
â””â”€â”€ tsconfig.json                     # âœ… TypeScript configuration

# IMPORTANT: NO src/renderer/, public/, or Electron-related files
# Frontend code is maintained in aerotage_time_reporting_app repo
```

## Development Priorities

### **Current Sprint Focus**
1. **Frontend Integration Support**: Help with API client implementation
2. **Performance Optimization**: Monitor and optimize existing endpoints
3. **Testing Enhancement**: Improve test coverage and integration tests
4. **Documentation Updates**: Keep API docs current with any changes

### **Next Sprint Preparation**
1. **Phase 4 Planning**: Design time entry management APIs
2. **Database Schema**: Plan time entry table structure and GSIs
3. **Timer Functionality**: Design start/stop/pause timer endpoints
4. **Approval Workflow**: Design manager approval process

### **Production Readiness**
1. **Staging Environment**: Deploy to staging for QA testing
2. **Performance Testing**: Load testing and optimization
3. **Security Review**: Final security audit and penetration testing
4. **Monitoring Enhancement**: Production-grade monitoring and alerting

## AWS CDK Development Rules

### Stack Organization (âœ… **IMPLEMENTED**)
1. **Single Responsibility**: Each stack has one clear purpose
2. **Environment Isolation**: Separate stacks for dev/staging/prod
3. **Resource Naming**: Consistent naming with environment prefixes
4. **Cross-Stack References**: CloudFormation exports for shared resources
5. **Stack Dependencies**: Explicit dependencies defined

### Current Stack Status
- âœ… **CognitoStack**: Authentication and user management
- âœ… **DatabaseStack**: DynamoDB tables with optimized GSIs
- âœ… **ApiStack**: API Gateway with 30+ Lambda functions
- âœ… **StorageStack**: S3 buckets with lifecycle policies
- âœ… **SESStack**: Email service with professional templates
- âœ… **DocumentationStack**: OpenAPI/Swagger UI hosting with CloudFront
- âœ… **MonitoringStack**: CloudWatch monitoring and alerting

## Lambda Function Development Rules

### Function Structure (âœ… **IMPLEMENTED**)
1. **Single Purpose**: Each function has one specific responsibility
2. **Handler Pattern**: Consistent handler pattern across all functions
3. **Error Handling**: Comprehensive error handling and logging
4. **Input Validation**: All inputs validated using TypeScript types
5. **Response Format**: Consistent API response format

### Current Function Status
- âœ… **30+ Functions Deployed**: All user management and security endpoints
- âœ… **Standardized Response Format**: Consistent JSON responses
- âœ… **Error Handling**: Comprehensive error handling implemented
- âœ… **Input Validation**: All inputs validated and sanitized
- âœ… **Monitoring**: CloudWatch logging and metrics active

### Function Template (âœ… **STANDARDIZED**)
```typescript
import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';
import { DynamoDBClient } from '@aws-sdk/client-dynamodb';

export const handler = async (event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> => {
  try {
    // Input validation
    // Business logic
    // Return success response
    return {
      statusCode: 200,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*'
      },
      body: JSON.stringify({ success: true, data: result })
    };
  } catch (error) {
    console.error('Function error:', error);
    return {
      statusCode: 500,
      body: JSON.stringify({ success: false, error: 'Internal server error' })
    };
  }
};
```

## Database Design Rules (âœ… **IMPLEMENTED**)

### Current Database Status
- âœ… **8 DynamoDB Tables**: Optimized for current access patterns
- âœ… **Global Secondary Indexes**: Efficient querying for all endpoints
- âœ… **Data Encryption**: All tables encrypted at rest
- âœ… **Backup Strategy**: Point-in-time recovery enabled
- âœ… **Performance**: <200ms average response time

### Implemented Tables
1. **aerotage-main-table-dev**: Primary data table
2. **aerotage-user-profiles-dev**: User profile information
3. **aerotage-user-preferences-dev**: User preferences and settings
4. **aerotage-user-security-settings-dev**: Security configuration
5. **aerotage-password-history-dev**: Password history tracking
6. **aerotage-user-sessions-dev**: Session management
7. **aerotage-user-invitations-dev**: Invitation system
8. **aerotage-user-activity-dev**: Activity logging

## Security Implementation (âœ… **ENTERPRISE-GRADE**)

### Authentication & Authorization (âœ… **IMPLEMENTED**)
- âœ… **JWT Tokens**: Cognito JWT tokens for API authentication
- âœ… **Role-Based Access**: Admin, Manager, Employee roles implemented
- âœ… **Password Security**: Strong policies, reset flow, history tracking
- âœ… **Session Management**: Multi-session tracking and control
- âœ… **Account Security**: Lockout protection, MFA support

### Security Features Status
- âœ… **Password Reset**: Email-based reset with secure codes
- âœ… **Security Settings**: User-configurable security options
- âœ… **Session Tracking**: IP, device, location tracking
- âœ… **Audit Logging**: Comprehensive security event logging
- âœ… **Rate Limiting**: Built-in protection against abuse

## API Design Rules (âœ… **IMPLEMENTED**)

### REST API Status
- âœ… **15+ Endpoints**: All user management and security endpoints live
- âœ… **Consistent Format**: Standardized request/response format
- âœ… **Error Handling**: Comprehensive error responses
- âœ… **Authentication**: Cognito JWT validation on all endpoints
- âœ… **CORS**: Configured for frontend integration
- âœ… **Rate Limiting**: Per-endpoint throttling implemented

### Response Format (âœ… **STANDARDIZED**)
```typescript
// Success Response
{
  "success": true,
  "data": { /* response data */ }
}

// Error Response
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "Human readable message",
    "details": { /* additional context */ }
  }
}
```

## Deployment & Environment Management (âœ… **OPERATIONAL**)

### Environment Status
- âœ… **Development**: Fully operational with all features
- ğŸ“‹ **Staging**: Ready for deployment
- ğŸ“‹ **Production**: Infrastructure ready, pending final testing

### Deployment Commands (âœ… **WORKING**)
```bash
# Development environment (âœ… DEPLOYED)
npm run deploy:dev

# Staging environment (ğŸ“‹ READY)
npm run deploy:staging

# Production environment (ğŸ“‹ READY)
npm run deploy:prod

# Destroy environment (dev/staging only)
npm run destroy:dev
```

## Monitoring & Observability (âœ… **ACTIVE**)

### CloudWatch Status
- âœ… **Structured Logging**: JSON format for all log messages
- âœ… **Custom Metrics**: Business KPIs tracking
- âœ… **Alarms**: Error rates, latency, and cost monitoring
- âœ… **Dashboards**: Real-time system health monitoring
- âœ… **SNS Alerts**: Production alert notifications

### Performance Metrics (âœ… **MONITORED**)
- **API Response Time**: <200ms average
- **Error Rate**: <1% in development
- **Lambda Duration**: Optimized memory allocation
- **DynamoDB Performance**: Efficient query patterns
- **Cost Monitoring**: Billing alerts and anomaly detection

## Testing Requirements (âœ… **IMPLEMENTED**)

### Test Coverage Status
- âœ… **Unit Tests**: 80%+ coverage for critical functions
- âœ… **Integration Tests**: End-to-end API workflows
- âœ… **Authentication Tests**: Cognito integration scenarios
- âœ… **Security Tests**: Password policies and validation
- âœ… **Manual Testing**: All endpoints verified

## Documentation Status (âœ… **COMPREHENSIVE**)

### Available Documentation
- âœ… **Interactive API Documentation**: Live Swagger UI with testing capabilities
- âœ… **OpenAPI Specification**: Complete OpenAPI 3.0 YAML specification
- âœ… **API Reference**: Complete endpoint documentation
- âœ… **OpenAPI System Guide**: Documentation system setup and usage
- âœ… **Project Status**: Current implementation status
- âœ… **Security Guide**: Security features and implementation
- âœ… **Deployment Guide**: Infrastructure deployment instructions
- âœ… **Frontend Integration**: Complete integration guide
- âœ… **Troubleshooting**: Common issues and solutions
- âœ… **Development Guide**: Local development setup

## Development Workflow (âœ… **ESTABLISHED**)

### Git Practices
1. **Conventional Commits**: Use conventional commit format
2. **Feature Branches**: Create branches for each feature/fix
3. **Pull Requests**: Require code review for all changes
4. **Deployment Tags**: Tag deployments with version numbers
5. **Documentation Updates**: Update docs with all changes

### Code Quality (âœ… **ENFORCED**)
- âœ… **TypeScript**: Strict mode enabled
- âœ… **ESLint**: AWS CDK recommended rules
- âœ… **Testing**: Comprehensive test coverage
- âœ… **Documentation**: All APIs documented

## Prohibited Practices

### Never Do
- Store secrets or credentials in code or environment variables
- Use deprecated AWS services or APIs
- Implement custom authentication instead of using Cognito
- Create overly broad IAM permissions
- Deploy directly to production without testing
- Use console.log in production (use proper logging)
- Hardcode environment-specific values
- Skip input validation for Lambda functions
- Create circular dependencies between stacks
- Use deprecated CDK constructs
- **Add frontend code (React, Electron, UI) to this repository** âŒ
- **Store frontend dependencies in package.json** âŒ
- **Implement UI logic in Lambda functions** âŒ
- **Include build tools for frontend applications** âŒ

### Always Do
- Follow AWS Well-Architected Framework principles
- Use CDK best practices and design patterns
- Implement proper error handling and logging
- Test infrastructure changes in non-production environments
- Use least privilege access for all IAM roles
- Monitor resource costs and optimize regularly
- Document API changes and breaking changes
- Version APIs and maintain backward compatibility
- **Keep infrastructure and API logic separate from frontend** âœ…
- **Coordinate API changes with frontend team** âœ…
- **Deploy backend infrastructure before frontend testing** âœ…
- **Maintain API documentation for frontend consumption** âœ…

## Current Development Context

### **When Working on This Project**
1. **Infrastructure is DEPLOYED**: Focus on optimization and new features
2. **APIs are LIVE**: Test against actual deployed endpoints
3. **Documentation is CURRENT**: Refer to `/docs` for accurate information
4. **Frontend Integration**: Support frontend team with API integration
5. **Next Phase Planning**: Prepare for time tracking implementation

### **Key Resources**
- **API Base URL**: `https://0z6kxagbh2.execute-api.us-east-1.amazonaws.com/dev/`
- **Interactive API Docs**: `https://d2xyhdliouir95.cloudfront.net` (Live Swagger UI)
- **OpenAPI Specification**: `/docs/openapi.yaml` for API specification
- **Documentation**: `/docs` directory with comprehensive guides
- **Project Status**: `/docs/PROJECT_STATUS.md` for current state
- **API Reference**: `/docs/API_REFERENCE.md` for endpoint details
- **Security Guide**: `/docs/SECURITY_GUIDE.md` for security features

### **Development Priorities**
1. **Support frontend integration** with existing APIs
2. **Optimize performance** of deployed endpoints
3. **Plan Phase 4** time tracking features
4. **Maintain documentation** accuracy
5. **Prepare for production** deployment

Remember: This repository contains a **production-ready backend infrastructure** with **15+ live API endpoints**. The focus is now on **frontend integration support**, **performance optimization**, and **planning the next development phases** for time tracking and project management features.
